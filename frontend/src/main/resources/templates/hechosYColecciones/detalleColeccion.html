<html th:replace="~{layout/base :: layout}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="css">
            <link rel="stylesheet" th:href="@{/css/detalleColeccion.css}" />
            <meta name="_csrf" th:content="${_csrf.token}"/>
            <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
        </div>
        <div class="container" th:fragment="contenido">
            <div class="breadcrumb">
                <a th:href="@{/inicio}"> Inicio </a> › <a th:href="@{/colecciones}"> Colecciones </a> › <p th:text ="${coleccion.titulo}"></p>
            </div>

            <div class="collection-header">
                <h1 class="collection-title" th:text=" ${coleccion.titulo}"></h1>
                <p class="collection-description" th:text="${coleccion.descripcion}"></p>

                <div class="collection-stats">
                    <div class="stat">
                        <span class="stat-label">Total de hechos</span>
                        <span class="stat-value" th:text="${coleccion.hechoIds.size()}"></span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Algoritmo de consenso</span>
                        <span class="stat-value" th:text="${coleccion.algoritmoDeConsenso}"></span>
                    </div>
                </div>

                <div class="collection-actions">
                    <a th:href="@{/hechos/nuevo}" class="btn btn-success">Agregar Hecho</a>
                </div>
            </div>

            <div class="controls-section">
                <h3 class="controls-title">Filtros y configuración</h3>

                <div class="mode-toggle">
                    <span class="toggle-label">Modo de navegación:</span>
                    <span style="margin-right: 0.5rem;">Irrestricto</span>
                    <div class="toggle-switch active">
                        <div class="toggle-slider"></div>
                    </div>
                    <span style="margin-left: 0.5rem;">Curado</span>
                    <span style="margin-left: 1rem; font-size: 0.85rem; color: #666;">
                        (Mostrando solo hechos con consenso verificado)
                    </span>
                </div>

                <div class="controls-grid">
                    <div class="control-group">
                        <label for="categoria-filter">Categoría</label>
                        <select id="categoria-filter">
                            <option value="quema-controlada" th:each="categoria : ${categorias}" th:text="${categoria.nombre}"></option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="fuente-filter">Fuente</label>
                        <select id="fuente-filter">
                            <option value="">Todas las fuentes</option>
                            <option value="dataset-oficial">Dataset oficial SNMF</option>
                            <option value="reportes-ciudadanos">Reportes ciudadanos</option>
                            <option value="bomberos-voluntarios">Bomberos voluntarios</option>
                            <option value="satelital-nasa">Datos satelitales NASA</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="fecha-desde">Fecha desde</label>
                        <input type="date" id="fecha-desde" value="2025-01-01">
                    </div>

                    <div class="control-group">
                        <label for="fecha-hasta">Fecha hasta</label>
                        <input type="date" id="fecha-hasta" value="2025-08-15">
                    </div>

                    <div class="control-group">
                        <label for="ubicacion-filter">Ubicación</label>
                        <input type="text" id="ubicacion-filter" placeholder="Provincia, ciudad, coordenadas...">
                    </div>

                    <div class="control-group">
                        <label for="busqueda-texto">Buscar en título/descripción</label>
                        <input type="text" id="busqueda-texto" placeholder="Palabras clave...">
                    </div>
                </div>

                <button class="btn btn-principal">Aplicar Filtros</button>
                <button class="btn btn-secondary">Limpiar</button>
            </div>

            <div class="hechos-grid">

                <!--//TODO CAMBIAR, AHORA ESTA UN METODO PARA ITERAR QUE ENCONTRE CON LOS HECHOS, PERO EN REALIDAD NECESITAMOS UN ID EN HECHO PARA ASOCIAR LA SOLICITUD AL ID, ENTRE OTRAS COSAS-->
                <!--<div class="hecho-card" th:each="hecho : ${coleccion.hechos}">
                    <h3 class="hecho-title" th:text="${hecho.titulo}"></h3>
                    <div class="hecho-category" th:text="${hecho.categoria}"></div>
                    <p class="hecho-description" th:text="${hecho.descripcion}"></p>
                    <div class="hecho-meta">
                        <div th:text="${hecho.fechaAcontecimiento}"><strong>Fecha del hecho:</strong> 12/08/2025</div>
                        <div th:text="${hecho.fechaCarga}"><strong>Reportado:</strong> 13/08/2025</div>
                        <div th:text="${hecho.provincia}"><strong>Ubicación:</strong> Santa Cruz, Argentina</div>
                        <div><strong>Coordenadas:</strong> -50.2938, -73.0138</div>
                    </div>


                    <div class="hecho-actions">
                        <a class="btn btn-principal" th:href="@{/hechos/1}">Ver Detalles</a>
                        <button class="btn btn-secondary">Solicitar Eliminación</button>
                    </div> -->
                    <div class="hecho-card" th:each="hecho : ${hechos}">
                        <h3 class="hecho-title" th:text="${hecho.titulo}"></h3>
                        <div class="hecho-category" th:text="${hecho.categoria.nombre}"></div>
                        <p class="hecho-description" th:text="${hecho.descripcion}"></p>

                        <div class="hecho-meta">
                            <div th:text="${hecho.fechaAcontecimiento}">
                                <strong>Fecha del hecho:</strong> 12/08/2025
                            </div>
                            <div th:text="${hecho.fechaCarga}">
                                <strong>Reportado:</strong> 13/08/2025
                            </div>
                            <div th:text="${hecho.provincia}">
                                <strong>Ubicación:</strong> Santa Cruz, Argentina
                            </div>
                            <div><strong>Coordenadas:</strong> -50.2938, -73.0138</div>
                            <div><strong>Cantidad de vistas:</strong><p th:text="${hecho.cantVistas}"></p></div>
                        </div>

                        <div class="hecho-actions">
                            <a class="btn btn-principal btn-verDetalleHecho"
                               th:href="@{/hechos/{id}(id=${hecho.id})}"
                               th:attr="data-handle=${hecho.id}">
                                Ver Detalles
                            </a>
                            <a class="btn btn-secondary"
                               th:href="@{/solicitud/{hechoId}(hechoId=${hecho.id})}">
                                Solicitar Eliminación
                            </a>
                        </div>
                    </div>
                </div>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const csrfMeta = document.querySelector('meta[name="_csrf"]');
                    const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
                    const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
                    const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : 'X-CSRF-TOKEN';

                    document.querySelectorAll('.btn-verDetalleHecho').forEach(anchor => {
                        anchor.addEventListener('click', (ev) => {
                            // Evitar navegación inmediata para poder disparar la petición primero
                            ev.preventDefault();

                            const handle = anchor.dataset.handle;
                            const targetHref = anchor.href;

                            if (!handle) {
                                // si no hay handle, navegamos normalmente
                                window.location.href = targetHref;
                                return;
                            }

                            // Construimos la URL del POST (ajustala si tu RequestMapping difiere)
                            const postUrl = `/hechos/${encodeURIComponent(handle)}/sumarVista`;

                            // Payload vacío (el controller solo usa path variable)
                            const body = ''; // o `coleccionId=...` si necesitas enviar algo

                            // Envío con fetch; keepalive permite que la petición trate de completarse aunque haya navegación
                            fetch(postUrl, {
                                method: 'POST',
                                credentials: 'same-origin',    // mantiene cookies/sesión
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    ...(csrfToken ? { [csrfHeader]: csrfToken } : {})
                                },
                                body: body,
                                keepalive: true
                            })
                                .catch(err => {
                                    // no queremos bloquear la navegación por un error de la suma de vista
                                    console.warn('No se pudo registrar vista (no bloquea navegación):', err);
                                })
                                .finally(() => {
                                    // navegamos al href (incluso si el POST aún está en progreso; keepalive ayuda)
                                    window.location.href = targetHref;
                                });
                        });
                    });
                });


            </script>
        </div>
</html>