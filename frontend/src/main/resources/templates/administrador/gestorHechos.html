<html th:replace="~{layout/base :: html}" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/gestorHechos.css}" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</div>

<div class="container" th:fragment="contenido">
    <div class="main-content">
        <div class="page-header">
            <div>
                <h1 class="page-title">Hechos</h1>
                <p class="page-subtitle">Gestiona los hechos recibidos de las distintas fuentes</p>
            </div>
            <button class="btn-add-new" onclick="location.href='/admin/importarCSV'">
                <i class="fas fa-file-upload"></i>
                Nueva Importación CSV
            </button>
        </div>

        <!-- Filters (sin cambios funcionales) -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Filtrar por Estado</label>
                    <select class="filter-select" id="statusFilter" onchange="filterRequests()">
                        <option value="">Seleccionar Estado</option>
                        <option value="pending">Pendiente</option>
                        <option value="approved">Aprobado</option>
                        <option value="rejected">Rechazado</option>
                        <option value="in-progress">En Progreso</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filtrar por Ubicación</label>
                    <input type="text" class="filter-input" placeholder="Ubicación del hecho" id="idFilterUbi" onkeyup="filterRequests()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Buscar por ID</label>
                    <input type="text" class="filter-input" placeholder="ID de Solicitud" id="idFilter" onkeyup="filterRequests()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Rango de Fechas</label>
                    <input type="date" class="filter-input" id="dateFilter" onchange="filterRequests()">
                </div>
                <button class="btn btn-reset" onclick="resetFilters()">Resetear Filtros</button>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-container" th:if="${hechos != null}">
            <table class="table">
                <thead>
                <tr>
                    <th>ID Hecho</th>
                    <th>Fecha del hecho</th>
                    <th>Título</th>
                    <th>Ubicación</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="requestsTable">
                <div class="alert alert-success" th:if="${mensaje}" th:text="${mensaje}"></div>
                <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

                <tr th:if="${#lists.isEmpty(hechos)}">
                    <td colspan="6" style="text-align:center; padding:24px;">No hay hechos registrados</td>
                </tr>

                <tr th:each="hecho : ${hechos}">
                    <td th:text="${hecho.id}">ID</td>
                    <td th:text="${hecho.fechaAcontecimiento != null ? hecho.fechaAcontecimiento.toLocalDate() : ''}">2025-01-01</td>
                    <td th:text="${hecho.titulo}">Título</td>
                    <td th:text="${hecho.provincia}">Provincia</td>
                    <td>
            <span th:classappend="${hecho.fueEliminado != null and !hecho.fueEliminado} ? 'status-badge status-approved' : 'status-badge status-rejected'"
                  th:text="${hecho.fueEliminado != null and !hecho.fueEliminado} ? 'APROBADO' : 'ELIMINADO'"></span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a class="btn-action view" title="Ver" th:href="@{/hechos/{id}(id=${hecho.id})}">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button type="button"
                                    class="btn-action delete"
                                    title="Eliminar"
                                    th:attr="data-handle=${hecho.id}"
                                    onclick="confirmDelete(this.dataset.handle)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>

                </tbody>
            </table>

            <!-- Footer con paginación -->
            <div class="table-footer" th:if="${totalPages > 0}">
                <div class="showing-text">
                    Mostrando <span th:text="${from}">1</span>–<span th:text="${to}">50</span>
                    de <span th:text="${totalElements}">0</span> hechos.
                </div>

                <div class="pagination" th:if="${totalPages > 1}">
                    <a class="pagination-btn"
                       th:classappend="${page == 0} ? ' disabled'"
                       th:href="@{|/admin/gestor-hechos?page=0&size=${size}|}">«</a>

                    <a class="pagination-btn"
                       th:classappend="${!hasPrev} ? ' disabled'"
                       th:href="@{|/admin/gestor-hechos?page=${prevPage}&size=${size}|}">‹</a>

                    <span class="pagination-btn active"
                          th:text="${page + 1}">1</span>

                    <a class="pagination-btn"
                       th:classappend="${!hasNext} ? ' disabled'"
                       th:href="@{|/admin/gestor-hechos?page=${nextPage}&size=${size}|}">›</a>

                    <a class="pagination-btn"
                       th:classappend="${page + 1 == totalPages} ? ' disabled'"
                       th:href="@{|/admin/gestor-hechos?page=${totalPages - 1}&size=${size}|}">»</a>
                </div>
            </div>
        </div>
        <div class="categoria-section">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Gestión de Categorías</h1>
                    <p class="page-subtitle">Administra las categorías disponibles para clasificar hechos</p>
                </div>
                <button class="btn btn-primary" onclick="mostrarModalCategoria()" style="align-self: end;">
                    <i class="fas fa-plus"></i>
                    Nueva Categoría
                </button>

            </div>


            <div class="table-container">
                <table class="table">
                    <thead th:if="${categorias != null && categorias.size() >= 1}">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${categorias == null || categorias.isEmpty()}">
                        <td colspan="3" style="text-align:center; padding:24px;">
                            <i class="fa-regular fa-folder-open fa-3x text-muted mb-3" style="display:block; margin-bottom:16px; opacity:0.3;"></i>
                            <h5 class="text-muted">No hay categorías registradas</h5>
                        </td>
                    </tr>

                    <tr th:if="${categorias != null && categorias.size() >= 1}" th:each="categoria : ${categorias}">
                        <td th:text="${categoria.id}">1</td>
                        <td th:text="${categoria.nombre}">Medio Ambiente</td>
                        <td>
                            <div class="action-buttons">
                                <button type="button"
                                        class="btn-action edit"
                                        title="Editar"
                                        th:attr="data-id=${categoria.id}, data-nombre=${categoria.nombre}"
                                        onclick="editarCategoria(this.dataset.id, this.dataset.nombre)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button"
                                        class="btn-action delete"
                                        title="Eliminar"
                                        th:attr="data-id=${categoria.id}"
                                        onclick="confirmarEliminarCategoria(this.dataset.id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Modal para crear/editar categoría -->
        <div id="modalCategoria" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitulo">Nueva Categoría</h3>
                    <button class="modal-close" onclick="cerrarModalCategoria()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!--
                  =================================================================
                  CORRECCIÓN APLICADA AQUÍ:
                  Cambiamos '__ID__' por 'PLACEHOLDER_ID' para evitar
                  que Thymeleaf lo procese incorrectamente.
                  =================================================================
                -->
                <form id="formCategoria"
                      method="post"
                      th:data-create-action="@{/admin/categorias/nueva}"
                      th:data-edit-action-template="@{/admin/categorias/PLACEHOLDER_ID/editar}">

                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" id="categoriaId" name="id" />

                    <div class="modal-body">
                        <div class="form-group">
                            <label for="categoriaNombre">Nombre de la Categoría *</label>
                            <input type="text"
                                   id="categoriaNombre"
                                   name="nombre"
                                   class="form-input"
                                   placeholder="Ej: Medio Ambiente, Educación, Salud..."
                                   required
                                   maxlength="100" />
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="cerrarModalCategoria()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-save"></i>
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>


    <form id="deleteCategoriaForm" th:method="delete" style="display:none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>

    <!-- Formulario oculto para eliminar -->
    <form id="deleteForm" th:method="post" style="display:none;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>

    <script>
        function confirmDelete(handle) {
            if (!handle) return;
            const doConfirm = () => {
                const form = document.getElementById('deleteForm');
                form.action = `/admin/hecho/${encodeURIComponent(handle)}/eliminar`;
                form.submit();
            };
            if (window.Swal) {
                Swal.fire({
                    title: '¿Eliminar hecho?',
                    text: 'Esta acción no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6'
                }).then(r => { if (r.isConfirmed) doConfirm(); });
            } else {
                if (confirm('¿Eliminar hecho? Esta acción no se puede deshacer')) doConfirm();
            }
        }

        function filterRequests(){ /* (placeholder, tu lógica actual) */ }
        function resetFilters(){ /* (placeholder, tu lógica actual) */ }

        // Mostrar modal para nueva categoría
        function mostrarModalCategoria() {
            const form = document.getElementById('formCategoria');
            form.reset();
            document.getElementById('modalTitulo').textContent = 'Nueva Categoría';
            document.getElementById('categoriaId').value = '';
            form.action = form.dataset.createAction;
            document.getElementById('modalCategoria').style.display = 'flex';
        }

        // Cerrar modal
        function cerrarModalCategoria() {
            document.getElementById('modalCategoria').style.display = 'none';
        }

        // Editar categoría
        function editarCategoria(id, nombre) {
            const form = document.getElementById('formCategoria');
            document.getElementById('modalTitulo').textContent = 'Editar Categoría';
            document.getElementById('categoriaId').value = id;
            document.getElementById('categoriaNombre').value = nombre;

            // --- CORRECCIÓN APLICADA AQUÍ ---
            const editTemplate = form.dataset.editActionTemplate;
            // Cambiamos '__ID__' por 'PLACEHOLDER_ID'
            form.action = editTemplate.replace('PLACEHOLDER_ID', encodeURIComponent(id));

            document.getElementById('modalCategoria').style.display = 'flex';
        }

        // Confirmar eliminación
        function confirmarEliminarCategoria(id) {
            if (!id) {
                console.warn('confirmarEliminarCategoria: id vacío');
                return;
            }

            const doDelete = () => {
                const form = document.getElementById('deleteCategoriaForm');
                form.action = `/admin/categorias/${encodeURIComponent(id)}/eliminar`;
                form.submit();
            };

            if (window.Swal) {
                Swal.fire({
                    title: '¿Eliminar categoría?',
                    text: 'Esta acción no se puede deshacer',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6'
                }).then(result => {
                    if (result.isConfirmed) doDelete();
                }).catch(err => {
                    console.error('Swal error:', err);
                });
            } else {
                if (window.confirm('¿Eliminar categoría? Esta acción no se puede deshacer')) {
                    doDelete();
                }
            }
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalCategoria')?.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModalCategoria();
            }
        });

        // Búsqueda en tiempo real
        document.getElementById('searchCategorias')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.admin-table tbody tr');

            rows.forEach(row => {
                if (row.cells.length > 1) {
                    const nombre = row.cells[1].textContent.toLowerCase();
                    row.style.display = nombre.includes(searchTerm) ? '' : 'none';
                }
            });
        });
    </script>
</div>
</html>

