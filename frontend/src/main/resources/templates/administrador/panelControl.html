<html th:replace="~{layout/baseAdmin :: html}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/panelControl.css}" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</div>

<div class="admin-layout" th:fragment="contenido">
  <!-- Sidebar Navigation -->
  <aside class="admin-sidebar">
    <nav class="sidebar-nav">
      <ul>
        <li class="nav-item active">
          <a href="#" class="nav-link">
            <i class="fas fa-tachometer-alt"></i>
            <span>Panel Principal</span>
          </a>
        </li>

        <li class="nav-item">
          <a th:href="@{/admin/gestor-solicitudes}" class="nav-link">
            <i class="fas fa-trash-alt"></i>
            <span>Solicitudes de Eliminación</span>
          </a>
        </li>

        <li class="nav-item">
          <a th:href="@{/admin/gestor-hechos}" class="nav-link">
            <i class="fas fa-file"></i>
            <span>Hechos</span>
          </a>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="admin-main">
    <div class="dashboard-header">
      <h1 th:text="${titulo}"></h1>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-folder"></i></div>
        <div class="stat-content">
          <h3>Total de Colecciones</h3>
          <div class="stat-number">250</div>
          <div class="stat-change positive">15 nuevas este mes</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-users"></i></div>
        <div class="stat-content">
          <h3>Usuarios Activos</h3>
          <div class="stat-number">1,200</div>
          <div class="stat-change positive">8% aumento en Q1</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-content">
          <h3>Solicitudes Pendientes</h3>
          <div class="stat-number">18</div>
          <div class="stat-change">7 solicitudes de eliminación</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon"><i class="fas fa-database"></i></div>
        <div class="stat-content">
          <h3>Fuentes de Datos</h3>
          <div class="stat-number">72</div>
          <div class="stat-change positive">5 nuevas integraciones</div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-header">
          <h3>Estado de Asignación de Colecciones</h3>
          <p>Resumen de la distribución de propiedad de colecciones.</p>
        </div>
        <div class="chart-content">
          <div class="pie-chart-placeholder">
            <div class="pie-slice assigned"></div>
            <div class="pie-slice unassigned"></div>
            <div class="pie-slice needs-reassignment"></div>
          </div>
          <div class="chart-legend">
            <div class="legend-item"><span class="legend-dot assigned"></span><span>Asignadas</span></div>
            <div class="legend-item"><span class="legend-dot unassigned"></span><span>Sin Asignar</span></div>
            <div class="legend-item"><span class="legend-dot needs-reassignment"></span><span>Requieren Reasignación</span></div>
          </div>
        </div>
      </div>

      <!-- Collections Management Table -->
      <div class="table-section">
        <div class="section-header">
          <h3>Gestión de Colecciones</h3>
          <div class="section-actions">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" placeholder="Buscar colecciones..." />
            </div>
            <button class="btn-refresh-table">
              <i class="fas fa-sync-alt"></i>
              Actualizar
            </button>
            <a href="crearColeccion.html" class="btn-add-new">
              <i class="fas fa-plus"></i>
              Nueva Colección
            </a>
          </div>
        </div>

        <div class="table-container">
          <table class="admin-table">
            <thead th:if="${colecciones.size() >= 1}">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Estado</th>
              <th>Hechos</th>
              <th>Consenso</th>
              <th>Última Actualización</th>
              <th>Propietario</th>
              <th>Fuente</th>
              <th>Acciones</th>
            </tr>
            </thead>
            <tbody>
            <div th:if="${colecciones.isEmpty()}" class="text-center py-5">
                <i class="fa-regular fa-folder-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay colecciones registradas</h5>
            </div>
            <tr th:if="${colecciones.size() >= 1}" th:each="coleccion : ${colecciones}">
              <td th:text="${coleccion.handle}">001</td>
              <td th:text="${coleccion.descripcion}">Puntos Críticos de Biodiversidad Global</td>
              <td><span class="status-badge active" th:text="${coleccion.handle}">Activa</span></td>
              <td th:text="${coleccion.hechoIds.size()}">1250</td>
              <td><span class="consensus-badge" th:text="${coleccion.algoritmoDeConsenso}">Absoluta</span></td>
              <td>15/03/2024</td>
              <td>Juan Lopez</td>
              <td>Biodiversity.org</td>
              <td>
                <div class="action-buttons">
                  <a href="editarColeccion.html" class="btn-action edit" title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <!-- FIX: se quitó un </button> suelto acá -->
                  <a class="btn-action view" title="Ver" th:href="@{/colecciones/{handle}(handle=${coleccion.handle})}">
                    <i class="fas fa-eye"></i>
                  </a>
                    <!-- botón en la fila (igual que el tuyo) -->
                    <button type="button"
                            class="btn-action delete"
                            title="Eliminar"
                            th:attr="data-handle=${coleccion.handle}"
                            onclick="confirmDelete(this.dataset.handle)">
                        <i class="fas fa-trash"></i>
                    </button>

                </div>
              </td>
            </tr>

            </tbody>
          </table>
        </div>
      </div> <!-- /table-section (colecciones) -->
    </div> <!-- /charts-section -->

    <!-- Recent Imports Table -->
    <div class="table-section">
      <div class="section-header">
        <h3>Importaciones Recientes</h3>
        <div class="section-actions">
          <button class="btn-add-new" onclick="location.href='./importadorArchivosCSV.html'">
            <i class="fas fa-file-upload"></i>
            Nueva Importación CSV
          </button>
        </div>
      </div>


      <!-- Formulario oculto único -->
      <form id="deleteForm" th:method="post" style="display:none;">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      </form>

      <script>
          function confirmDelete(handle) {
              if (!handle) {
                  console.warn('confirmDelete: handle vacío');
                  return;
              }

              const doConfirm = () => {
                  const form = document.getElementById('deleteForm');
                  form.action = `/admin/${encodeURIComponent(handle)}/eliminar`;
                  form.submit();
              };

              if (window.Swal) {
                  Swal.fire({
                      title: '¿Eliminar colección?',
                      text: 'Esta acción no se puede deshacer',
                      icon: 'warning',
                      showCancelButton: true,
                      confirmButtonText: 'Sí, eliminar',
                      cancelButtonText: 'Cancelar',
                      confirmButtonColor: '#d33',
                      cancelButtonColor: '#3085d6'
                  }).then(result => {
                      if (result.isConfirmed) doConfirm();
                  }).catch(err => {
                      console.error('Swal error:', err);
                  });
              } else {
                  if (window.confirm('¿Eliminar colección? Esta acción no se puede deshacer')) {
                      doConfirm();
                  }
              }
          }
      </script>
  </main>
</div>

</html>
