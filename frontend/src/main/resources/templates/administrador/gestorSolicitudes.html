<html th:replace="~{layout/baseAdmin :: html}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/gestorSolicitudes.css}" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</div>
    <div class="container" th:fragment="contenido">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item">
                        <a th:href="@{/admin/panel-control}" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Panel Principal</span>
                        </a>
                    </li>
                    <li class="nav-item">

                    <li class="nav-item active">
                        <a href="#" class="nav-link">
                            <i class="fas fa-trash-alt"></i>
                            <span>Solicitudes de Eliminación</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a th:href="@{/admin/gestor-hechos}" class="nav-link">
                            <i class="fas fa-file"></i>
                            <span>Hechos</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Solicitudes de Eliminación de Hechos</h1>
                    <p class="page-subtitle">Gestiona las solicitudes de eliminación de hechos enviadas por los usuarios
                    </p>
                </div>
                <div class="header-actions update-button">
                    <a href="#" class="btn-add-new">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </a>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Filtrar por Estado</label>
                        <select class="filter-select" id="statusFilter" onchange="filterRequests()">
                            <option value="">Seleccionar Estado</option>
                            <option value="pending">Pendiente</option>
                            <option value="approved">Aprobado</option>
                            <option value="rejected">Rechazado</option>
                            <option value="in-progress">En Progreso</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Filtrar por Usuario</label>
                        <select class="filter-select" id="userFilter" onchange="filterRequests()">
                            <option value="">Seleccionar Usuario</option>
                            <option value="alice@example.com">alice@example.com</option>
                            <option value="bob@example.com">bob@example.com</option>
                            <option value="charlie@example.com">charlie@example.com</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Buscar por ID</label>
                        <input type="text" class="filter-input" placeholder="ID de Solicitud" id="idFilter"
                            onkeyup="filterRequests()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Rango de Fechas</label>
                        <input type="date" class="filter-input" id="dateFilter" onchange="filterRequests()">
                    </div>
                    <button class="btn btn-reset" onclick="resetFilters()">Resetear Filtros</button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table th:if="${solicitudes.size() >= 1}" class="table">
                    <thead>
                        <tr>
                            <th>ID Solicitud</th>
                            <th>Fecha</th>
                            <th>Usuario</th>
                            <th>Hecho a Eliminar</th>
                            <th>Razón</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <div class="alert alert-success" th:if="${mensaje}" th:text="${mensaje}"></div>
                    <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>
                    <tbody id="requestsTable" th:if="${!solicitudes.isEmpty()}">
                    <tr th:each="solicitud : ${solicitudes}"
                        th:attr="data-status=${solicitud.estado}, data-id=${solicitud.id}">
                        <td th:text="${solicitud.id}">DR001</td>
                        <td th:text="${solicitud.fechaEntrada}">2023-10-26</td>
                        <td>alice@example.com</td>
                        <td><small style="color: #6c757d;" th:text="${solicitud.hechoId}">ID: F1234</small></td>
                        <td th:text="${solicitud.justificacion.length() > 100} ? ${solicitud.justificacion.substring(0,100)} + '...' : ${solicitud.justificacion}">
                            Información desactualizada
                        </td>

                        <!-- badge dinámico según estado -->
                        <td>
      <span th:classappend="${solicitud.estado == 'ACEPTADA'} ? 'status-badge status-approved' :
                             (solicitud.estado == 'RECHAZADA' ? 'status-badge status-rejected' : 'status-badge status-pending')"
            th:text="${solicitud.estado}">
        Pendiente
      </span>
                        </td>

                        <!-- botones -->
                        <td>
                            <div class="action-buttons">
                                <!-- Botón Aprobar -->
                                <button type="button" class="btn-action approve"
                                        title="Aprobar"
                                        th:attr="data-id=${solicitud.id}"
                                        onclick="aprobar(this.dataset.id)"
                                        th:disabled="${solicitud.estado == 'ACEPTADA'}">
                                    <i class="fa-solid fa-check"></i>
                                </button>

                                <!-- Botón Ver -->
                                <button type="button" class="btn-action view" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <!-- Botón Rechazar -->
                                <button type="button" class="btn-action reject"
                                        title="Rechazar"
                                        th:attr="data-id=${solicitud.id}"
                                        th:disabled="${solicitud.estado == 'RECHAZADA'}">
                                    <i class="fas fa-xmark"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div class="table-footer">
                    <div class="showing-text">Mostrando 5 de 12 solicitudes.</div>
                    <div class="pagination">
                        <button class="pagination-btn">«</button>
                        <button class="pagination-btn">‹</button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <button class="pagination-btn">›</button>
                        <button class="pagination-btn">»</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Formulario oculto único -->
        <form id="aprobarForm" th:method="post" style="display:none;">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        </form>

        <script>
            function aprobar(id) {
                if (!id) {
                    console.warn('aprobar: id vacío');
                    return;
                }

                const doConfirm = () => {
                    const form = document.getElementById('aprobarForm');
                    form.action = `/admin/${encodeURIComponent(id)}/aprobar`;
                    form.submit();
                };

                if (window.Swal) {
                    Swal.fire({
                        title: '¿Aprobar solicitud?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, aprobar',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6'
                    }).then(result => {
                        if (result.isConfirmed) doConfirm();
                    }).catch(err => {
                        console.error('Swal error:', err);
                    });
                } else {
                    if (window.confirm('¿Aprobar solicitud?')) {
                        doConfirm();
                    }
                }
            }
        </script>
    </div>



</html>