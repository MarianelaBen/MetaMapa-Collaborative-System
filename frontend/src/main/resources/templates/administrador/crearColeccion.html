<html th:replace="~{layout/base :: layout}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="css">
  <link rel="stylesheet" th:href="@{/css/crearColeccion.css}" />
</div>

<div th:fragment="contenido" class="container">
  <main class="admin-main">

  <!-- Breadcrumb -->
    <div class="page-header">
      <h1 th:text="${titulo}">Crear Nueva Colección</h1>
      <div class="breadcrumb" style="margin-top:8px;">
        <a th:href="@{/admin/panel-control}">Panel Principal</a>
        <i class="fas fa-chevron-right" style="margin:0 6px;"></i>
        <span>Crear Nueva Colección</span>
      </div>
    </div>

  <!-- Mensajes -->
  <div class="alert alert-success" th:if="${mensaje}" th:text="${mensaje}"></div>
  <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>


  <!-- Form Container -->
    <div class="form-container">
      <!-- el back hoy solo usa titulo, descripcion, algoritmoDeConsenso -->
      <form class="collection-form"
            th:action="@{/colecciones/nueva}"
            method="post"
            th:object="${coleccion}">

        <section class="form-section">
          <h2 class="section-title">Información General</h2>

            <div class="criterio-block">
              <h3 class="subsection-title">Título de la Colección</h3>
            <label for="titulo" ></label>
            <input type="text" id="titulo" th:field="*{titulo}" class="form-input" placeholder="Título de la Colección" required>
          </div>

          <div class="criterio-block">
              <h3 class="subsection-title">Descripción</h3>
            <label for="descripcion" ></label>
            <textarea id="descripcion" th:field="*{descripcion}" class="form-textarea"
                      rows="4" placeholder="Descripción detallada de la colección..."></textarea>
          </div>
        </section>

        <!-- Fuentes -->
        <section class="form-section">
          <h2 class="section-title">Fuentes </h2>

          <div class="subsection">
            <h3 class="subsection-title">Seleccionar fuentes</h3>

            <div id="fuentes-toggle" class="fuentes-toggle" style="display:flex; gap:1rem;">

              <button
                      type="button"
                      class="btn-fuente-toggle"
                      data-tipo="DINAMICA">
                <i class="fas fa-bolt"></i> Dinámica
              </button>

              <button
                      type="button"
                      class="btn-fuente-toggle"
                      data-tipo="ESTATICA">
                <i class="fas fa-database"></i> Estática
              </button>

              <button
                      type="button"
                      class="btn-fuente-toggle"
                      data-tipo="PROXY">
                <i class="fas fa-random"></i> Proxy
              </button>
            </div>

            <!-- Campo oculto REAL que va al controller -->
            <input type="hidden" id="fuenteTipos" name="fuenteTipos">
          </div>
        </section>

        <!-- Criterios -->

        <section class="form-section">
          <h2 class="section-title">Criterios</h2>

          <!-- Selector de criterio -->
          <div class="form-group">
            <label for="criterioSelect" class="subsection-title">Agregar criterio de pertenencia</label>
            <select id="criterioSelect" class="form-select">
              <option value="">+ Seleccionar criterio</option>
              <option value="categoria">Categoría</option>
              <option value="descripcion">Descripción</option>
              <option value="fecha_acontecimiento">Fecha del Acontecimiento</option>
              <option value="fecha_carga">Fecha de Carga</option>
              <option value="lugar">Lugar</option>
              <option value="origen">Origen</option>
              <option value="titulo">Título</option>
            </select>
          </div>

          <!-- Contenedor dinámico donde aparecerán los criterios -->
          <div id="criterios-container"></div>
          <input type="hidden" id="categoriasSeleccionadas" name="categoriasSeleccionadas">

        </section>

        <!-- Templates ocultos para cada criterio -->
        <div id="criterio-templates" style="display:none;">

          <!-- CATEGORÍA -->
          <div data-template="categoria" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Categoría</h3>
            <div class="dynamic-field">
              <div class="field-group">
                <input type="text" name="criterioCategoria[]" class="form-input"
                       placeholder="Ej: Incendio forestal">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

          <!-- DESCRIPCIÓN -->
          <div data-template="descripcion" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Descripción</h3>
            <div class="dynamic-field">
              <div class="field-group">
                <input type="text" name="criterioDescripcion[]" class="form-input"
                       placeholder="Ej: Contiene 'incendio'">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

          <!-- FECHA ACONTECIMIENTO -->
          <div data-template="fecha_acontecimiento" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Fecha del Acontecimiento</h3>
            <div class="dynamic-field">
              <div class="field-group" style="flex-wrap: wrap;">
                <input type="date" name="criterioFechaAcontecimientoDesde[]" class="form-input"
                       placeholder="Desde">
                <input type="date" name="criterioFechaAcontecimientoHasta[]" class="form-input"
                       placeholder="Hasta">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

          <!-- FECHA CARGA -->
          <div data-template="fecha_carga" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Fecha de Carga</h3>
            <div class="dynamic-field">
              <div class="field-group" style="flex-wrap: wrap;">
                <input type="date" name="criterioFechaCargaDesde[]" class="form-input">
                <input type="date" name="criterioFechaCargaHasta[]" class="form-input">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

          <!-- LUGAR -->
          <div data-template="lugar" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Lugar</h3>
            <div class="dynamic-field">
              <div class="field-group" style="flex-wrap: wrap;">
                <input type="text" name="criterioLugarLat[]" class="form-input" placeholder="Latitud">
                <input type="text" name="criterioLugarLon[]" class="form-input" placeholder="Longitud">
                <input type="number" name="criterioLugarRango[]" class="form-input" placeholder="Rango">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

          <!-- ORIGEN -->
          <div data-template="origen" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Origen</h3>
            <div class="dynamic-field">
              <div class="field-group">
                <input type="text" name="criterioOrigen[]" class="form-input"
                       placeholder="Ej: DINAMICA">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

          <!-- TÍTULO -->
          <div data-template="titulo" class="criterio-block">
            <h3 class="subsection-title">Filtrar por Título</h3>
            <div class="dynamic-field">
              <div class="field-group">
                <input type="text" name="criterioTitulo[]" class="form-input"
                       placeholder="Texto en el título">
                <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <hr>
          </div>

        </div>


        <!-- Configuración Adicional -->
        <section class="form-section">
          <h2 class="section-title">Configuración Adicional</h2>

          <div class="form-row">
            <div class="form-group">
              <label for="privacidad" class="form-label">Nivel de Privacidad</label>
              <select id="privacidad" name="privacidad" class="form-select">
                <option value="publico">Público</option>
                <option value="privado">Privado</option>
                <option value="restringido">Restringido</option>
              </select>
            </div>

            <div class="form-group">
              <label for="consenso" class="form-label">Algoritmo de Consenso</label>
              <select id="consenso" class="form-select" th:field="*{algoritmoDeConsenso}">
                <option value="">— Seleccionar —</option>
                <option value="CONSENSO_ABSOLUTO">Absoluta</option>
                <option value="MAYORIA_SIMPLE">Mayoria Simple</option>
                <option value="MULTIPLES_MENCIONES">Multiples Menciones</option>
              </select>
            </div>
          </div>

          <div class="checkbox-section">
            <div class="checkbox-group">
              <input type="checkbox" id="activa" name="activa" class="form-checkbox">
              <label for="activa" class="checkbox-label">Activar colección inmediatamente</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="notificaciones" name="notificaciones" class="form-checkbox">
              <label for="notificaciones" class="checkbox-label">Habilitar notificaciones para nuevos hechos</label>
            </div>
          </div>
        </section>

        <!-- Form Actions -->
        <div class="form-actions">
          <a th:href="@{/colecciones}" class="btn-cancel">
            <i class="fas fa-times"></i>
            Cancelar
          </a>
          <button type="button" class="btn-draft">
            <i class="fas fa-save"></i>
            Guardar como Borrador
          </button>
          <button type="submit" class="btn-create">
            <i class="fas fa-check"></i>
            Crear Cambios
          </button>
        </div>
      </form>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      console.log(">>> SCRIPT DE FUENTES INICIADO <<<");

      const botones = document.querySelectorAll(".btn-fuente-toggle");
      const hidden = document.getElementById("fuenteTipos");

      console.log("Botones encontrados:", botones.length);
      console.log("Hidden encontrado:", hidden);

      botones.forEach(boton => {
        console.log("Asignando listener a:", boton.dataset.tipo);

        boton.addEventListener("click", () => {

          console.log("CLICK en:", boton.dataset.tipo);

          boton.classList.toggle("active");
          console.log("Estado active:", boton.classList.contains("active"));

          const seleccionados = [...document.querySelectorAll(".btn-fuente-toggle.active")]
                  .map(b => b.dataset.tipo);

          console.log("Seleccionados ahora:", seleccionados);

          hidden.value = seleccionados.join(",");
          console.log("Valor del hidden ahora:", hidden.value);
        });
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const select = document.getElementById("criterioSelect");
      const container = document.getElementById("criterios-container");
      const templates = document.querySelectorAll("#criterio-templates [data-template]");

      select.addEventListener("change", () => {
        const tipo = select.value;
        if (!tipo) return;
        const temp = document.querySelector(`#criterio-templates [data-template="${tipo}"]`);
        if (!temp) return;
        const clone = temp.cloneNode(true);
        clone.querySelector(".btn-remove-field").addEventListener("click", () => {
          clone.remove();
        });
        container.appendChild(clone);
        select.value = "";
      });

    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector(".collection-form");
      form.addEventListener("submit", () => {
        // 1) Tomar todos los campos de categoría que se hayan agregado
        const categorias = [...document.querySelectorAll('input[name="criterioCategoria[]"]')]
                .map(input => input.value)
                .filter(v => v && v.trim() !== "");
        document.getElementById("categoriasSeleccionadas").value = JSON.stringify(categorias);
      });
    });
  </script>


</div>
</html>