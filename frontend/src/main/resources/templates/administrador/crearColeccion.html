<html th:replace="~{layout/base :: layout}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="css">
    <link rel="stylesheet" th:href="@{/css/crearColeccion.css}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</div>

<div th:fragment="contenido" class="container">
    <main class="admin-main">

        <div class="page-header">
            <h1 th:text="${titulo}">Crear Nueva Colección</h1>
            <div class="breadcrumb" style="margin-top:8px;">
                <a th:href="@{/admin/panel-control}">Panel Principal</a>
                <i class="fas fa-chevron-right" style="margin:0 6px;"></i>
                <span>Crear Nueva Colección</span>
            </div>
        </div>

        <div class="alert alert-success" th:if="${mensaje}" th:text="${mensaje}"></div>
        <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

        <div class="form-container">

            <form class="collection-form"
                  th:action="@{/colecciones/nueva}"
                  method="post"
                  th:object="${coleccion}">

                <section class="form-section">
                    <h2 class="section-title">Información General</h2>

                    <div class="criterio-block">
                        <h3 class="subsection-title">Título de la Colección</h3>
                        <label for="titulo"></label>
                        <input type="text" id="titulo" th:field="*{titulo}" class="form-input" placeholder="Título de la Colección" required>
                    </div>

                    <div class="criterio-block">
                        <h3 class="subsection-title">Descripción</h3>
                        <label for="descripcion"></label>
                        <textarea id="descripcion" th:field="*{descripcion}" class="form-textarea"
                                  rows="4" placeholder="Descripción detallada de la colección..."></textarea>
                    </div>
                </section>

                <section class="form-section">
                    <h2 class="section-title">Fuentes</h2>
                    <div class="subsection">
                        <h3 class="subsection-title">Seleccionar fuentes</h3>
                        <div id="fuentes-toggle" class="fuentes-toggle" style="display:flex; gap:1rem;">
                            <button type="button" class="btn-fuente-toggle" data-tipo="DINAMICA">
                                <i class="fas fa-bolt"></i> Dinámica
                            </button>
                            <button type="button" class="btn-fuente-toggle" data-tipo="ESTATICA">
                                <i class="fas fa-database"></i> Estática
                            </button>
                            <button type="button" class="btn-fuente-toggle" data-tipo="PROXY">
                                <i class="fas fa-random"></i> Proxy
                            </button>
                        </div>
                        <input type="hidden" id="fuenteTipos" name="fuenteTipos">
                    </div>
                </section>

                <section class="form-section">
                    <h2 class="section-title">Criterios</h2>

                    <div class="form-group">
                        <label for="criterioSelect" class="subsection-title">Agregar criterio de pertenencia</label>
                        <select id="criterioSelect" class="form-select">
                            <option value="">+ Seleccionar criterio</option>
                            <option value="categoria">Categoría</option>
                            <option value="descripcion">Descripción</option>
                            <option value="fecha_acontecimiento">Fecha del Acontecimiento</option>
                            <option value="fecha_carga">Fecha de Carga</option>
                            <option value="lugar">Lugar Geográfico</option>
                            <option value="origen">Origen</option>
                            <option value="titulo">Título</option>
                        </select>
                    </div>

                    <div id="criterios-container"></div>

                    <input type="hidden" id="categoriasSeleccionadas" name="categoriasSeleccionadas">
                </section>

                <section class="form-section">
                    <h2 class="section-title">Configuración Adicional</h2>
                    <div class="form-row">

                        <div class="form-group">
                            <label for="consenso" class="form-label">Algoritmo de Consenso</label>
                            <select id="consenso" class="form-select" th:field="*{algoritmoDeConsenso}">
                                <option value="">— Seleccionar —</option>
                                <option value="CONSENSO_ABSOLUTO">Absoluta</option>
                                <option value="MAYORIA_SIMPLE">Mayoria Simple</option>
                                <option value="MULTIPLES_MENCIONES">Multiples Menciones</option>
                            </select>
                        </div>
                    </div>

                </section>

                <div class="form-actions">
                    <a th:href="@{/colecciones}" class="btn-cancel">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                    <button type="submit" class="btn-create">
                        <i class="fas fa-check"></i> Crear Colección
                    </button>
                </div>

            </form> </div>

        <div id="criterio-templates" style="display:none;">

            <div data-template="categoria" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Categoría</h3>
                <div class="dynamic-field">
                    <div class="field-group">
                        <select name="criterioCategoria[]" class="form-select">
                            <option value="">-- Seleccione una categoría --</option>
                            <option th:each="cat : ${listaCategorias}"
                                    th:value="${cat.nombre}"
                                    th:text="${cat.nombre}"></option>
                        </select>
                        <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <hr>
            </div>

            <div data-template="descripcion" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Descripción</h3>
                <div class="dynamic-field">
                    <div class="field-group">
                        <input type="text" name="criterioDescripcion[]" class="form-input" placeholder="Ej: Contiene 'incendio'">
                        <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <hr>
            </div>

            <div data-template="fecha_acontecimiento" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Fecha del Acontecimiento</h3>
                <div class="dynamic-field">
                    <div class="field-group" style="flex-wrap: wrap;">
                        <input type="date" name="criterioFechaAcontecimientoDesde[]" class="form-input">
                        <input type="date" name="criterioFechaAcontecimientoHasta[]" class="form-input">
                        <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <hr>
            </div>

            <div data-template="fecha_carga" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Fecha de Carga</h3>
                <div class="dynamic-field">
                    <div class="field-group" style="flex-wrap: wrap;">
                        <input type="date" name="criterioFechaCargaDesde[]" class="form-input">
                        <input type="date" name="criterioFechaCargaHasta[]" class="form-input">
                        <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <hr>
            </div>

            <div data-template="lugar" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Lugar Geográfico</h3>
                <div class="dynamic-field">
                    <div class="form-row" style="display:flex; gap:1rem; margin-bottom:1rem;">
                        <div style="flex:1">
                            <label class="form-label">Provincia</label>
                            <select name="criterioLugarProvincia[]" class="form-select select-provincia">
                                <option value="">Cualquier Provincia</option>
                            </select>
                        </div>
                        <div style="flex:1">
                            <label class="form-label">Radio (Km)</label>
                            <input type="number" name="criterioLugarRango[]" class="form-input" placeholder="Ej: 5 (Opcional)">
                        </div>
                    </div>

                    <label class="form-label">Seleccionar punto en el mapa (Opcional)</label>
                    <div class="map-container" style="height: 300px; width: 100%; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ccc;"></div>

                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" name="criterioLugarLat[]" class="form-input input-lat" placeholder="Latitud" readonly style="background:#f9f9f9; font-size:0.8rem;">
                        <input type="text" name="criterioLugarLon[]" class="form-input input-lon" placeholder="Longitud" readonly style="background:#f9f9f9; font-size:0.8rem;">
                    </div>

                    <button type="button" class="btn-remove-field" style="color: #dc3545; background: none; border: none; cursor: pointer;">
                        <i class="fas fa-trash"></i> Eliminar Criterio
                    </button>
                </div>
                <hr>
            </div>

            <div data-template="origen" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Origen</h3>
                <div class="dynamic-field">
                    <div class="field-group">

                        <select name="criterioOrigen[]" class="form-select">
                            <option value="">-- Seleccione un Origen --</option>

                            <option th:each="origen : ${listaOrigenes}"
                                    th:value="${origen}"
                                    th:text="${origen}"></option>
                        </select>

                        <button type="button" class="btn-remove-field" style="margin-left: 10px; color: #dc3545; background: none; border: none; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <hr>
            </div>

            <div data-template="titulo" class="criterio-block">
                <h3 class="subsection-title">Filtrar por Título</h3>
                <div class="dynamic-field">
                    <div class="field-group">
                        <input type="text" name="criterioTitulo[]" class="form-input" placeholder="Texto en el título">
                        <button type="button" class="btn-remove-field"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <hr>
            </div>

        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {

            // --- 1. Gestión de Fuentes (Botones) ---
            const botonesFuentes = document.querySelectorAll(".btn-fuente-toggle");
            const hiddenFuentes = document.getElementById("fuenteTipos");

            if(botonesFuentes.length > 0) {
                botonesFuentes.forEach(boton => {
                    boton.addEventListener("click", () => {
                        boton.classList.toggle("active");
                        const seleccionados = [...document.querySelectorAll(".btn-fuente-toggle.active")]
                            .map(b => b.dataset.tipo);
                        hiddenFuentes.value = seleccionados.join(",");
                    });
                });
            }

            // --- 2. Gestión de Criterios ---
            const provinciasArg = [
                "Buenos Aires", "Catamarca", "Chaco", "Chubut", "Ciudad Autónoma de Buenos Aires",
                "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La Rioja",
                "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San Juan", "San Luis",
                "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del Fuego", "Tucumán"
            ];

            const selectCriterio = document.getElementById("criterioSelect");
            const containerCriterios = document.getElementById("criterios-container");

            if (selectCriterio) {
                selectCriterio.addEventListener("change", () => {
                    const tipo = selectCriterio.value;
                    if (!tipo) return;

                    const template = document.querySelector(`#criterio-templates [data-template="${tipo}"]`);
                    if (!template) return;
                    const clone = template.cloneNode(true);

                    if (tipo === "lugar") {
                        initMapaYProvincias(clone);
                    }

                    const btnEliminar = clone.querySelector(".btn-remove-field");
                    if(btnEliminar) {
                        btnEliminar.addEventListener("click", () => clone.remove());
                    }

                    containerCriterios.appendChild(clone);
                    selectCriterio.value = "";
                });
            }

            // --- 3. VALIDACIÓN EN EL ENVÍO (LO NUEVO) ---
            const form = document.querySelector(".collection-form");
            if(form) {
                form.addEventListener("submit", (e) => {
                    let errores = [];

                    // A. Validar Fuentes
                    if (!hiddenFuentes.value || hiddenFuentes.value.trim() === "") {
                        errores.push("Debes seleccionar al menos una Fuente de datos (Dinámica, Estática o Proxy).");
                    }

                    // B. Validar Consenso
                    const consenso = document.getElementById("consenso");
                    if (!consenso.value || consenso.value === "") {
                        errores.push("Debes seleccionar un Algoritmo de Consenso.");
                    }

                    // Si hay errores, frenamos el envío y avisamos
                    if (errores.length > 0) {
                        e.preventDefault(); // IMPORTANTE: Evita que vaya al backend
                        // Usamos alert o inyectamos el HTML de error
                        alert("⚠️ Atención:\n\n" + errores.join("\n"));
                    }
                });
            }

            // --- HELPER: Mapa Leaflet ---
            function initMapaYProvincias(elementoClonado) {
                const selectProv = elementoClonado.querySelector(".select-provincia");
                if(selectProv) {
                    provinciasArg.forEach(p => {
                        const opt = document.createElement("option");
                        opt.value = p;
                        opt.text = p;
                        selectProv.appendChild(opt);
                    });
                }

                const mapDiv = elementoClonado.querySelector(".map-container");
                if(!mapDiv) return;

                const uniqueID = "map-" + Math.random().toString(36).substr(2, 9);
                mapDiv.id = uniqueID;

                setTimeout(() => {
                    const map = L.map(uniqueID).setView([-38.4161, -63.6167], 4);
                    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(map);

                    let marcador = null;
                    const inLat = elementoClonado.querySelector(".input-lat");
                    const inLon = elementoClonado.querySelector(".input-lon");

                    map.on('click', function(e) {
                        const lat = e.latlng.lat.toFixed(6);
                        const lng = e.latlng.lng.toFixed(6);
                        if (marcador) marcador.setLatLng(e.latlng);
                        else marcador = L.marker(e.latlng).addTo(map);

                        if(inLat) inLat.value = lat;
                        if(inLon) inLon.value = lng;
                    });

                    setTimeout(() => { map.invalidateSize(); }, 200);
                }, 100);
            }
        });
    </script>

</div>
</html>