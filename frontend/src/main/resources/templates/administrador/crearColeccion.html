<html th:replace="~{layout/base :: layout}" xmlns:th="http://www.thymeleaf.org">

<div th:fragment="css">
  <link rel="stylesheet" th:href="@{/css/crearColeccion.css}" />
</div>

<div th:fragment="contenido" class="container">
  <main class="admin-main">

  <!-- Breadcrumb -->
    <div class="page-header">
      <h1 th:text="${titulo}">Crear Nueva Colección</h1>
      <div class="breadcrumb" style="margin-top:8px;">
        <a th:href="@{/admin/panel-control}">Panel Principal</a>
        <i class="fas fa-chevron-right" style="margin:0 6px;"></i>
        <span>Crear Nueva Colección</span>
      </div>
    </div>

  <!-- Mensajes -->
  <div class="alert alert-success" th:if="${mensaje}" th:text="${mensaje}"></div>
  <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>


  <!-- Form Container -->
    <div class="form-container">
      <!-- el back hoy solo usa titulo, descripcion, algoritmoDeConsenso -->
      <form class="collection-form"
            th:action="@{/colecciones/nueva}"
            method="post"
            th:object="${coleccion}">

        <section class="form-section">
          <h2 class="section-title">Información General</h2>

          <div class="form-group">
            <label for="titulo" class="form-label">Título de la Colección</label>
            <input type="text" id="titulo" th:field="*{titulo}" class="form-input" placeholder="Título de la Colección" required>
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">Descripción</label>
            <textarea id="descripcion" th:field="*{descripcion}" class="form-textarea"
                      rows="4" placeholder="Descripción detallada de la colección..."></textarea>
          </div>
        </section>

        <!-- Fuentes y Criterios -->
        <section class="form-section">
          <h2 class="section-title">Fuentes y Criterios</h2>

          <div class="subsection">
            <h3 class="subsection-title">Seleccionar fuentes</h3>

            <div id="fuentes-toggle" class="fuentes-toggle" style="display:flex; gap:1rem;">

              <button
                      type="button"
                      class="btn-fuente-toggle"
                      data-tipo="DINAMICA">
                <i class="fas fa-bolt"></i> Dinámica
              </button>

              <button
                      type="button"
                      class="btn-fuente-toggle"
                      data-tipo="ESTATICA">
                <i class="fas fa-database"></i> Estática
              </button>

              <button
                      type="button"
                      class="btn-fuente-toggle"
                      data-tipo="PROXY">
                <i class="fas fa-random"></i> Proxy
              </button>
            </div>

            <!-- Campo oculto REAL que va al controller -->
            <input type="hidden" id="fuenteTipos" name="fuenteTipos">
          </div>

          <div class="subsection">
            <h3 class="subsection-title">Criterios</h3>
            <div id="criterios-container">
              <div class="dynamic-field">
                <div class="field-group">
                  <input type="text" name="criterios[]" class="form-input"
                         placeholder="Criterios de pertenencia">
                  <button type="button" class="btn-remove-field">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
            <button type="button" class="btn-add-field" >
              <i class="fas fa-plus"></i>
              Añadir Criterios
            </button>
          </div>
        </section>

        <!-- Configuración Adicional -->
        <section class="form-section">
          <h2 class="section-title">Configuración Adicional</h2>

          <div class="form-row">
            <div class="form-group">
              <label for="privacidad" class="form-label">Nivel de Privacidad</label>
              <select id="privacidad" name="privacidad" class="form-select">
                <option value="publico">Público</option>
                <option value="privado">Privado</option>
                <option value="restringido">Restringido</option>
              </select>
            </div>

            <div class="form-group">
              <label for="consenso" class="form-label">Algoritmo de Consenso</label>
              <select id="consenso" class="form-select" th:field="*{algoritmoDeConsenso}">
                <option value="">— Seleccionar —</option>
                <option value="CONSENSO_ABSOLUTO">Absoluta</option>
                <option value="MAYORIA_SIMPLE">Mayoria Simple</option>
                <option value="MULTIPLES_MENCIONES">Multiples Menciones</option>
              </select>
            </div>
          </div>

          <div class="checkbox-section">
            <div class="checkbox-group">
              <input type="checkbox" id="activa" name="activa" class="form-checkbox">
              <label for="activa" class="checkbox-label">Activar colección inmediatamente</label>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="notificaciones" name="notificaciones" class="form-checkbox">
              <label for="notificaciones" class="checkbox-label">Habilitar notificaciones para nuevos hechos</label>
            </div>
          </div>
        </section>

        <!-- Form Actions -->
        <div class="form-actions">
          <a th:href="@{/colecciones}" class="btn-cancel">
            <i class="fas fa-times"></i>
            Cancelar
          </a>
          <button type="button" class="btn-draft">
            <i class="fas fa-save"></i>
            Guardar como Borrador
          </button>
          <button type="submit" class="btn-create">
            <i class="fas fa-check"></i>
            Crear Cambios
          </button>
        </div>
      </form>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      console.log(">>> SCRIPT DE FUENTES INICIADO <<<");

      const botones = document.querySelectorAll(".btn-fuente-toggle");
      const hidden = document.getElementById("fuenteTipos");

      console.log("Botones encontrados:", botones.length);
      console.log("Hidden encontrado:", hidden);

      botones.forEach(boton => {
        console.log("Asignando listener a:", boton.dataset.tipo);

        boton.addEventListener("click", () => {

          console.log("CLICK en:", boton.dataset.tipo);

          boton.classList.toggle("active");
          console.log("Estado active:", boton.classList.contains("active"));

          const seleccionados = [...document.querySelectorAll(".btn-fuente-toggle.active")]
                  .map(b => b.dataset.tipo);

          console.log("Seleccionados ahora:", seleccionados);

          hidden.value = seleccionados.join(",");
          console.log("Valor del hidden ahora:", hidden.value);
        });
      });
    });
  </script>
     </div>
</html>